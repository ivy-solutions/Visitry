general:
  artifacts:
    - "/home/ubuntu/build/Visitry/android/debug.apk"
    - "/home/ubuntu/build/Visitry/android/release-unsigned.apk"
    - "/home/ubuntu/build/Visitry/bundle.tar.gz"
    - "/home/ubuntu/build/Visitry/mobile/android/Visitry.apk"
machine:
  java:
    version: oraclejdk8
  node:
    version: 6.11.4
dependencies:
  pre:
    - npm install -g npm
    - npm -g install ssh2
    - npm install -g mup # install meteor-up for deployment
    - mkdir $HOME/build/
    - mkdir $HOME/build/Visitry/
    # Android SDK Platform 25
    - if [ ! -d "/usr/local/android-sdk-linux/platforms/android-25" ]; then echo y | android update sdk --no-ui --all --filter "android-25"; fi
    # Android Support Repository, revision 39 / Local Maven repository for Support Libraries
    - if [ ! -d "/usr/local/android-sdk-linux/extras/android/m2repository/com/android/support/design/25.0.0" ]; then echo y | android update sdk --no-ui --all --filter "extra-android-m2repository"; fi
  override:
    - meteor || curl https://install.meteor.com | /bin/sh
    - npm install -g spacejam
    - meteor npm install bcrypt
    - meteor npm install
    - meteor npm install --save babel-runtime
  cache_directories:
    - ~/.meteor
    - /usr/local/android-sdk-linux/platforms/android-25
    - /usr/local/android-sdk-linux/extras/android/m2repository
test:
  override:
    - mkdir -p $CIRCLE_TEST_REPORTS/junit
    - npm test
    - if [[ -e test-results.xml ]]; then cp test-results.xml $CIRCLE_TEST_REPORTS/junit/test-results.xml; fi
deployment:
  dev:
    branch: dev
    commands:
      - aws s3 cp s3://visitry-build-info/site-ssl-certs/dev/bundle.crt $HOME/Visitry/.deploy/dev/bundle.crt
      - aws s3 cp s3://visitry-build-info/site-ssl-certs/dev/private.key $HOME/Visitry/.deploy/dev/private.key
      - meteor build $HOME/build/Visitry/mobile --server https://dev.visitry.org
      - cd $HOME/Visitry/.deploy/dev && mup deploy
  staging:
    branch: master
    owner: ivy-solutions
    commands:
      - aws s3 cp s3://visitry-build-info/push-notifications/VisitryPushProd.pem $HOME/Visitry/private/VisitryPushProd.pem
      - aws s3 cp s3://visitry-build-info/push-notifications/PushKey1216.pem $HOME/Visitry/private/PushKey1216.pem
      - aws s3 cp s3://visitry-build-info/site-ssl-certs/staging/bundle.crt $HOME/Visitry/.deploy/staging/bundle.crt
      - aws s3 cp s3://visitry-build-info/site-ssl-certs/staging/private.key $HOME/Visitry/.deploy/staging/private.key
      - meteor build $HOME/build/Visitry/mobile --server https://test.visitry.org
      - sh $HOME/Visitry/.deploy/staging/android-sign-apk.sh
      - cd $HOME/Visitry/.deploy/staging && mup deploy
  production:
    tag: /.*?/
    owner: ivy-solutions
    commands:
      - aws s3 cp s3://visitry-build-info/push-notifications/VisitryPushProd.pem $HOME/Visitry/private/VisitryPushProd.pem
      - aws s3 cp s3://visitry-build-info/push-notifications/PushKey1216.pem $HOME/Visitry/private/PushKey1216.pem
      - aws s3 cp s3://visitry-build-info/site-ssl-certs/production/bundle.crt $HOME/Visitry/.deploy/production/bundle.crt
      - aws s3 cp s3://visitry-build-info/site-ssl-certs/production/private.key $HOME/Visitry/.deploy/production/private.key
      - meteor build $HOME/build/Visitry/mobile --server https://production.visitry.org
      - sh $HOME/Visitry/.deploy/production/android-sign-apk.sh
      - cd $HOME/Visitry/.deploy/production && mup deploy
